# GraphCast Forecasting Integration

This document describes the GraphCast forecasting integration for the weather modeling pipeline.

## Overview

The `run_graphcast_forecast.py` script processes existing zarr forecast files through Google DeepMind's GraphCast operational model to generate extended weather forecasts up to 10 days ahead.

## Features

- **Automated Processing**: Processes all zarr files in the `./outputs` directory
- **Extended Forecasting**: Generates predictions for 240 hours (10 days) with 6-hour intervals
- **Operational Model**: Uses GraphCast_operational model optimized for real-time forecasting
- **Comprehensive Output**: Merges all forecasts into a single zarr file
- **Standalone Operation**: Can be run independently after initial forecast generation

## Prerequisites

1. **Existing Zarr Files**: The script requires zarr files generated by the existing pipeline (04_zarr.py)
2. **GraphCast Dependencies**: JAX, Haiku, and GraphCast libraries
3. **Internet Connection**: Required to download model weights from Google Cloud Storage

## Installation

Run the installation script to set up GraphCast dependencies:

```bash
./install_graphcast.sh
```

This will:
- Create a Python virtual environment
- Install all required dependencies
- Download GraphCast from GitHub
- Apply necessary workarounds

## Usage

### Basic Usage

```bash
# Activate the virtual environment
source .venv/bin/activate

# Run GraphCast forecasting
python run_graphcast_forecast.py
```

### Input Requirements

The script expects zarr files in the `./outputs` directory with the naming pattern:
```
YYYYMMDD_HH_###_output.zarr
```

For example:
- `20250807_12_000_output.zarr`
- `20250807_18_000_output.zarr`

### Output

The script generates a single merged forecast file:
```
./graphcast_outputs/graphcast_forecast_YYYY_MM_DD_HH.zarr
```

This file contains:
- All input forecast runs as separate dimensions
- Extended predictions for each run (240 hours ahead)
- 6-hour interval timesteps (40 total steps per run)
- Complete meteorological variables from the original data

## Data Flow

```
Existing Zarr Files → GraphCast Model → Extended Forecasts → Merged Output
     (t, t-6)           (240h ahead)        (All runs)      (Single file)
```

## Model Details

- **Model**: GraphCast_operational
- **Resolution**: 0.25 degree (high resolution)
- **Pressure Levels**: 13 levels
- **Input Variables**: Temperature, wind, geopotential height, surface variables
- **Forecast Length**: 240 hours (10 days)
- **Time Step**: 6 hours

## Configuration

Key parameters can be modified in `run_graphcast_forecast.py`:

```python
FORECAST_HOURS = 240        # Total forecast length
FORECAST_INTERVAL = 6       # Hours between predictions
ZARR_INPUT_DIR = "./outputs"           # Input directory
GRAPHCAST_OUTPUT_DIR = "./graphcast_outputs"  # Output directory
```

## Logging

The script generates detailed logs in:
- Console output (INFO level)
- `graphcast_forecast.log` file

## Error Handling

The script includes comprehensive error handling for:
- Missing dependencies
- Invalid zarr files
- Model loading failures
- Network connectivity issues
- Memory constraints

## Memory Requirements

GraphCast requires significant memory:
- **Minimum**: 8GB RAM
- **Recommended**: 16GB+ RAM
- **GPU**: Optional but recommended for faster processing

## Troubleshooting

### Common Issues

1. **Import Errors**: Run `./install_graphcast.sh` to install dependencies
2. **Memory Errors**: Reduce the number of forecast steps or use a smaller model
3. **Network Errors**: Check internet connection for model download
4. **No Zarr Files**: Ensure the existing pipeline has generated zarr files

### Dependency Issues

If GraphCast installation fails:

```bash
# Manual installation
source .venv/bin/activate
pip install --upgrade https://github.com/deepmind/graphcast/archive/master.zip
pip install jax dm-haiku google-cloud-storage
```

### Performance Optimization

For better performance:
- Use GPU acceleration if available
- Increase system memory
- Process fewer zarr files at once
- Use the smaller GraphCast_small model for testing

## Integration with Existing Pipeline

The GraphCast script is designed to work seamlessly with the existing weather pipeline:

1. **Pipeline generates zarr files** → `./outputs/YYYYMMDD_HH_###_output.zarr`
2. **GraphCast processes zarr files** → Extended forecasts
3. **Output merged file** → `./graphcast_outputs/graphcast_forecast_YYYY_MM_DD_HH.zarr`

## Future Enhancements

Potential improvements:
- Automatic pipeline integration
- Real-time processing
- Multiple model support
- Custom forecast lengths
- Ensemble forecasting
- Performance monitoring

## Support

For issues related to:
- **GraphCast Model**: See [GraphCast GitHub repository](https://github.com/google-deepmind/graphcast)
- **Weather Pipeline**: Check existing pipeline documentation
- **Integration**: Review this documentation and log files
